**********************************************************************                      Do-file for All Municipalities               **                     Estimations Paper No. 3 in a PC               **             Usando la familia de comandos xsmle, shp2dta y  spmat **                              All Models                           * *                            All Matrices                           **                           Date: Noviembre, 2021                   **********************************************************************set more offclear allclear mata*ssc install shp2dta*ssc install spmat*ssc install xsmleglobal rutabox "C:\Users\Leonardo\Dropbox\"global rutabox "C:\Users\lmoralzu\Dropbox\"*global rutabox "C:\Users\zurit\Dropbox\"*Open shape in Stata/*cd "/Users/Eleo 1/Dropbox/Papers/Papers CI/Spatial_Analisis_IC/Estimation 3paperv3"*/*cd "E:\Spatial_Analisis_IC\Estimation 3paperv3"*cd "${rutabox}\Spatial_Analisis_IC\Estimation 3paperv3"*cd "${rutabox}\Spatial_Analisis_IC\LM\Estimation 3paperv3" cd "${rutabox}\Spatial_Analisis_IC\LM\Estimation 3paperv4"   /*06/05/2022->Cambi√≥ una variable, copio y pego la nueva carpeta en LM*/  shp2dta using mpio, database(data3paper) coordinates(coor3paper) replace/*genid(id)  gencentroids(c)  replace*/*Databaseuse "data3paper.dta", clear/*gsort y_cgen _id=_nsave"data3paper.dta", replace*Coordenadasuse "coor3paper.dta", cleargen _id=_nsave "coor3paper.dta", replace*/*Check shapefile correctly convertedspmap using          "coor3paper.dta", id(_ID)spmap HECTARES using "coor3paper.dta", id(_ID)/*=================================================================*//*Creando Diferentes Matrices*//*Create queen contiguity matrix  default qeen, +rook for rook*/use data3paper, clearspmat contiguity W using coor3paper, id(_ID) normalize(row)spmat save W using W3paper.spmat, replace*Explore queen matrixspmat summarize W, links detail*Importando matrices creadas en *global Wmatrix "Wq1 Wq2 Wq3 W1k W2k W3k W4k W5k"foreach W of global Wmatrix{spmat import `W'  using "${rutabox}\Spatial_Analisis_IC\LM\Stata_CI_Paper3\\`W'.txt", replacespmat save   `W' using `W'.spmat, replace}*spmat save Wr1n using Wr1n3paper.spmat, replace spmat summarize W,   links detail spmat summarize Wq1, links detail  /*====================================================================================*/ *Spatial panel regresion*clear all*clear mata/*====================================================================================*/ /*spmat use W using "W3paper.spmat*/*spmat use Wr using "Wr3paper.spmatuse "data3paper.dta", clearkeep MPIOS _IDrename MPIOS idmunsort idmuncountduplicates report idmunduplicates list idmunduplicates tag idmun, g(dup)save "Id_matrix_data.dta",replaceclear/*use "E:\Spatial_Analisis_IC\Stata_CI_Paper3\dataset for paper3_v1.dta", clear This dataset should yield results submited to JDE*/use "${rutabox}\Spatial_Analisis_IC\LM\Stata_CI_Paper3\dataset for paper3_v4.dta", clear  /*06/05/2022*/rename id idyearduplicates report idmun yearmerge m:1 idmun using "Id_matrix_data.dta", keep(3)xtset _ID yeartab year, g(year_)gen L1_er_=L1.er_gen L1_asp_=L1.asp_gen L1_ver_=L1.verdrop if year==2001replace dpark=0 if dpark==.replace dresguardo=0 if dresguardo==. keep if year<2016*Balancear el panelforeach v of varlist infrastructurepcc humancappcc ver conflict propertypcc induscomerpcc gaspcc nontaxincomepcc royaltiespcc cofinancingpcc pserv{bys _ID    : egen munmean=mean(`v')replace `v'=munmean if `v'==.bys idstate:  egen depmean=mean(`v')replace `v'=depmean if `v'==.drop munmean depmean}spbalance/*Results */*mkdir "${rutabox}\Spatial_Analisis_IC\LM\Stata_CI_Paper3\Results"global rutaresult "${rutabox}\Spatial_Analisis_IC\LM\Stata_CI_Paper3\Results"capture rm "${rutaresult}\Results0522.xls"capture rm "${rutaresult}\Results0522.txt"global control "L1_er_ L1_asp_ conflict dpark dresguardo infrastructurepcc humancappcc induscomerpcc gaspcc nontaxincomepcc royaltiespcc pserv"xtset _ID year/*Saving and exporting information to matlab */preservekeep  _ID year delta_coca ${control}gen  year2= yeardrop yearrename year2 yearxtset year _ID /*within transformations in stata require data to be organized time id */order _ID year delta_coca ${control}export delimited using "${rutabox}\Spatial_Analisis_IC\LM\Stata_CI_Paper3\do files Paper3 CI\EstimacionesLM\Data.csv", novarnames nolabel replaceexport delimited using "${rutabox}\Spatial_Analisis_IC\LM\Stata_CI_Paper3\do files Paper3 CI\EstimacionesLM\Data.csv", novarnames nolabel replaceexport excel     using "${rutabox}\Spatial_Analisis_IC\LM\Stata_CI_Paper3\do files Paper3 CI\EstimacionesLM\Data.xls", replacerestorecapture log closelog using "${rutabox}\Spatial_Analisis_IC\LM\Stata_CI_Paper3\Results\SumStats052022.smcl", replacesum coca delta_coca er_ asp_ ver conflict ///dpark dresguardo infrastructurepcc humancappcc ///induscomerpcc gaspcc nontaxincomepcc royaltiespcc pservlog close /*Opening log-file*/capture log closelog using "${rutabox}\Spatial_Analisis_IC\LM\Stata_CI_Paper3\Results\ResultSpatialModels052022.smcl", replace*OLSreg   delta_coca ${control} , noconsreg   delta_coca ${control} i.year, noconsxtreg delta_coca ${control}, fe xtreg delta_coca ${control} i.year, fe *Fixed Effects Regressionxtreg delta_coca ${control} i.year, fe cluster(_ID)outreg2 using paper3_v10, alpha(0.01, 0.05, 0.10) excel dec(2) ct(SEM,Wn) append*Spatial Models, All matrices All models*global Wmatrix "Wq1 Wq2 Wq3 W1k W2k W3k W4k W5k"foreach W of global Wmatrix{*Spatial lag model(SAR)xsmle delta_coca ${control}, wmat(`W') model(sar) fe type(both) nsim(25) effectsoutreg2 using "${rutaresult}\Results0522.xls", alpha(0.01, 0.05, 0.10) excel dec(2) ct(SAR,`W') append*Spatial error model (SEM)xsmle delta_coca ${control}, emat(`W') model(sem) fe type(both) nsim(25)outreg2 using "${rutaresult}\Results0522.xls", alpha(0.01, 0.05, 0.10) excel dec(2) ct(SEM,`W') append/*Durbin (SDM)*/xsmle delta_coca ${control}, wmat(`W') model(sdm) fe type(both) nsim(25) effectsoutreg2 using "${rutaresult}\Results0522.xls", alpha(0.01, 0.05, 0.10) excel dec(2) ct(SDM,`W') append*Test nested modeltest [Wx]L1_er_= [Wx]L1_asp_= [Wx]conflict= /// [Wx]dpark= [Wx]dresguardo= [Wx]infrastructurepcc= [Wx]humancappcc= /// [Wx]induscomerpcc= [Wx]gaspcc= [Wx]nontaxincomepcc= [Wx]royaltiespcc= [Wx]pserv=0/*Durbin Error*/sum yearlocal m=r(min)local M=r(max)global matrices ""* * * * *foreach v of global control {*dis("`v'")matrix R=J(1,1,.)forval y=`m'/`M'{*dis("`y'")preservekeep if year==`y'spmat lag  W_`v' W `v'mkmat W_`v'matrix R= [R \  W_`v' ]restore 	}matrix R = R[2..rowsof(R),1]matrix W_`v'= Rglobal matrices "${matrices} W_`v'"}dis("${matrices}")sort year _ID     /*Warning this is key*/foreach w of global matrices{svmat  `w'rename `w'1 `w'}xtset _ID yearxsmle delta_coca ${control} W_*, emat(`W') model(sem) fe type(both) nsim(25)outreg2 using "${rutaresult}\Results0522.xls", alpha(0.01, 0.05, 0.10) excel dec(2) ct(SDEM,`W') appendtest W_L1_er_= W_L1_asp_= W_conflict= /// W_dpark= W_dresguardo= W_infrastructurepcc= W_humancappcc= /// W_induscomerpcc= W_gaspcc= W_nontaxincomepcc= W_royaltiespcc= W_pserv=0 drop W_*} log close/*   +Estimaciones Efectos totales con Intervalos de confianza   +Estimaciones con Submuestras por periodos del modelo preferido: SDEM+Wq1*/*Spatial Models, All matrices All models*   Wq1log using "${rutabox}\Spatial_Analisis_IC\LM\Stata_CI_Paper3\Results\ResultSpatialModels052022RC.smcl", replacelocal W "Wq1"/*Durbin Error*/sum yearlocal m=r(min)local M=r(max)global matrices ""* * * * *foreach v of global control {*dis("`v'")matrix R=J(1,1,.)forval y=`m'/`M'{*dis("`y'")preservekeep if year==`y'spmat lag  W_`v' W `v'mkmat W_`v'matrix R= [R \  W_`v' ]restore 	}matrix R = R[2..rowsof(R),1]matrix W_`v'= Rglobal matrices "${matrices} W_`v'"}dis("${matrices}")sort year _ID     /*Warning this is key*/foreach w of global matrices{svmat  `w'rename `w'1 `w'}*Estimacion todo el periodo + Efectos Marginales*xtset _ID yearxsmle delta_coca ${control} W_*, emat(`W') model(sem) fe type(both) nsim(25)foreach v of global control {lincom `v'+W_`v'}capture rm "${rutaresult}\Results0522RC.xls"capture rm "${rutaresult}\Results0522RC.xls"/* * * * * * * * * * * * S u b p e r i o d o s  * * * * * * * * * * * * */*>2007matrix gt2007=J(20,2,.)xtset _ID yearxsmle delta_coca ${control} W_* if year>2007, emat(`W') model(sem) fe type(both) nsim(25)outreg2 using "${rutaresult}\Results0522RC.xls", alpha(0.01, 0.05, 0.10) excel dec(2) ct(SAR,>2007) appendlocal i=1foreach v of varlist L1_er_ L1_asp_ conflict dpark dresguardo infrastructurepcc humancappcc induscomerpcc gaspcc nontaxincomepcc royaltiespcc pserv {lincom `v'+W_`v'matrix gt2007[`i',1]=r(estimate) matrix gt2007[`i',2]=r(se)local i=`i'+1}    *<=2007 matrix lt2007=J(20,2,.)xtset _ID yearxsmle delta_coca ${control} W_* if year<=2007, emat(`W') model(sem) fe type(both) nsim(25)outreg2 using "${rutaresult}\Results0522RC.xls", alpha(0.01, 0.05, 0.10) excel dec(2) ct(SAR,<=2007) appendlocal i=1foreach v of varlist L1_er_ L1_asp_ conflict dpark            infrastructurepcc humancappcc induscomerpcc gaspcc nontaxincomepcc royaltiespcc pserv {lincom `v'+W_`v'matrix lt2007[`i',1]=r(estimate) matrix lt2007[`i',2]=r(se)local i=`i'+1}*>2004matrix gt2004=J(20,2,.)xtset _ID yearxsmle delta_coca ${control} W_* if year>2004, emat(`W') model(sem) fe type(both) nsim(25)outreg2 using "${rutaresult}\Results0522RC.xls", alpha(0.01, 0.05, 0.10) excel dec(2) ct(SAR,>2004) appendlocal i=1foreach v of varlist L1_er_ L1_asp_ conflict dpark dresguardo infrastructurepcc humancappcc induscomerpcc gaspcc nontaxincomepcc royaltiespcc pserv {lincom `v'+W_`v'matrix gt2004[`i',1]=r(estimate) matrix gt2004[`i',2]=r(se)local i=`i'+1}*<=2004 matrix lt2004=J(20,2,.)xtset _ID yearxsmle delta_coca ${control} W_* if year<=2004, emat(`W') model(sem) fe type(both) nsim(25)outreg2 using "${rutaresult}\Results0522RC.xls", alpha(0.01, 0.05, 0.10) excel dec(2) ct(SAR,<=2004) appendlocal i=1foreach v of varlist        L1_asp_ conflict                 infrastructurepcc humancappcc induscomerpcc gaspcc nontaxincomepcc royaltiespcc pserv {lincom `v'+W_`v'matrix lt2004[`i',1]=r(estimate) matrix lt2004[`i',2]=r(se)local i=`i'+1}*>2005matrix gt2005=J(20,2,.)xtset _ID yearxsmle delta_coca ${control} W_* if year>2005, emat(`W') model(sem) fe type(both) nsim(25)outreg2 using "${rutaresult}\Results0522RC.xls", alpha(0.01, 0.05, 0.10) excel dec(2) ct(SAR,>2005) appendlocal i=1foreach v of varlist L1_er_ L1_asp_ conflict dpark dresguardo infrastructurepcc humancappcc induscomerpcc gaspcc nontaxincomepcc royaltiespcc pserv {lincom `v'+W_`v'matrix gt2005[`i',1]=r(estimate) matrix gt2005[`i',2]=r(se)local i=`i'+1}*<=2005 matrix lt2005=J(20,2,.)xtset _ID yearxsmle delta_coca ${control} W_* if year<=2005, emat(`W') model(sem) fe type(both) nsim(25)outreg2 using "${rutaresult}\Results0522RC.xls", alpha(0.01, 0.05, 0.10) excel dec(2) ct(SAR,<=2005) appendlocal i=1foreach v of varlist L1_er_ L1_asp_ conflict                  infrastructurepcc humancappcc induscomerpcc gaspcc nontaxincomepcc royaltiespcc pserv {lincom `v'+W_`v'matrix lt2005[`i',1]=r(estimate) matrix lt2005[`i',2]=r(se)local i=`i'+1}/* * * * * * * * * * * * S u b p e r i o d o s  * * * * * * * * * * * * */drop W_*log closeclearsvmat gt2007 svmat lt2007 svmat gt2004 svmat lt2004 svmat gt2005 svmat lt2005save "${rutaresult}\Lincom.dta"